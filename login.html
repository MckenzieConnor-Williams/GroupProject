<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="Style.css" />
        <link rel="stylesheet" href="loginStyle.css" />
        <title>Login</title>
    </head>
    <body>
        <main class="center-container">
            <section id="login-container">
                <h1 id="login-title">Welcome Back</h1>
                <p class="subtext">Sign in to start your quiz</p>
                
                <form id="login-form">
                    <label for="email-login" class="bold-label login-label">Email</label>
                    <input
                        type="email"
                        id="email-login"
                        name="email-login"
                        placeholder="Enter your email"
                        class="login-item"
                        required
                    />

                    <label for="password-login" class="bold-label login-label">Password</label>
                    <input
                        type="password"
                        id="password-login"
                        name="password-login"
                        class="login-item"
                        placeholder="Enter your password"
                        required
                    />

                    <input type="submit" value="Sign In" class="login-item" id="login-button" />
                </form>



                <p class="login-footer">
                    Don't have an account?
                    <a href="signup.html">Sign up</a>
                </p>
            </section>
        </main>
        <script>
            (function () {
                const LOCAL_USERS_KEY = 'syntaxstudy_users';

                function getLocalUsers() {
                    try {
                        const raw = localStorage.getItem(LOCAL_USERS_KEY);
                        const parsed = JSON.parse(raw || '[]');
                        return Array.isArray(parsed) ? parsed : [];
                    } catch (err) {
                        console.error('Failed to parse local users', err);
                        return [];
                    }
                }

                async function getServerUsers() {
                    try {
                        const res = await fetch('http://localhost:3000/users');
                        if (!res.ok) throw new Error(res.statusText || 'Network error');
                        const users = await res.json();
                        return Array.isArray(users) ? users : [];
                    } catch (err) {
                        return [];
                    }
                }

                function normalizeUser(user) {
                    return {
                        id: user.id || null,
                        name: (user.name || '').trim(),
                        email: (user.email || '').trim().toLowerCase(),
                        password: user.password || ''
                    };
                }

                async function getCombinedUsers() {
                    const [serverUsers, localUsers] = await Promise.all([
                        getServerUsers(),
                        Promise.resolve(getLocalUsers())
                    ]);
                    const byEmail = new Map();
                    [...serverUsers, ...localUsers].forEach((user) => {
                        const normalized = normalizeUser(user);
                        if (normalized.email) byEmail.set(normalized.email, normalized);
                    });
                    return [...byEmail.values()];
                }

                const btn = document.getElementById('load-users');
                const container = document.getElementById('users-list');
                btn.addEventListener('click', async () => {
                    container.textContent = 'Loading...';
                    try {
                        const users = await getCombinedUsers();
                        const ul = document.createElement('ul');
                        users.forEach((u) => {
                            const li = document.createElement('li');
                            const label = u.name || 'No name';
                            li.textContent = `${u.id || '-'}: ${label} (${u.email || 'no email'})`;
                            ul.appendChild(li);
                        });
                        container.innerHTML = '';
                        container.appendChild(ul);
                    } catch (err) {
                        container.textContent = 'Failed to load users';
                        console.error(err);
                    }
                });

            
                const form = document.getElementById('login-form');
                let msg = document.getElementById('login-message');
                if (!msg) {
                    msg = document.createElement('div');
                    msg.id = 'login-message';
                    msg.style.marginTop = '8px';
                    form.parentNode.insertBefore(msg, form.nextSibling);
                }

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    msg.textContent = 'Checking credentials...';
                    const email = document.getElementById('email-login').value.trim().toLowerCase();
                    const password = document.getElementById('password-login').value;
                    try {
                        const users = await getCombinedUsers();
                        const user = users.find((u) => u.email === email);
                        if (!user) {
                            msg.textContent = 'User not found';
                            return;
                        }
                        if (user.password !== password) {
                            msg.textContent = 'Incorrect password';
                            return;
                        }
                        const displayName = user.name || user.email;
                        msg.textContent = `Welcome, ${displayName}! Redirecting...`;
                        setTimeout(() => { window.location.href = 'index.html'; }, 800);
                    } catch (err) {
                        msg.textContent = 'Login failed';
                        console.error(err);
                    }
                });
            })();
        </script>
    </body>
</html>
