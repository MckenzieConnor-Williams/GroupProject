<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="Style.css" />
        <link rel="stylesheet" href="loginStyle.css" />
        <title>Login</title>
    </head>
    <body>
        <main class="center-container">
            <section id="login-container">
                <h1 id="login-title">Welcome Back</h1>
                <p id="login-subtext">Sign in to start your quiz</p>

                <form id="login-form">
                    <label for="email-login" class="bold-label login-label">Email</label>
                    <input
                        type="email"
                        id="email-login"
                        name="email-login"
                        placeholder="Enter your email"
                        class="login-item"
                        required
                    />

                    <label for="password-login" class="bold-label login-label">Password</label>
                    <input
                        type="password"
                        id="password-login"
                        name="password-login"
                        class="login-item"
                        placeholder="Enter your password"
                        required
                    />

                    <input type="submit" value="Sign In" class="login-item" id="login-button" />
                </form>

                <button type="button" id="load-users" class="login-item" style="margin-top:8px">Load users</button>
                <div id="users-list" style="margin-top:12px"></div>

                <p class="login-footer">
                    Don't have an account?
                    <a href="signup.html">Sign up</a>
                </p>
            </section>
        </main>
        <script>
            (function () {
                const btn = document.getElementById('load-users');
                const container = document.getElementById('users-list');
                btn.addEventListener('click', async () => {
                    container.textContent = 'Loading...';
                    try {
                        const res = await fetch('http://localhost:3000/users');
                        if (!res.ok) throw new Error(res.statusText || 'Network error');
                        const users = await res.json();
                        const ul = document.createElement('ul');
                        users.forEach(u => {
                            const li = document.createElement('li');
                            li.textContent = `${u.id}: ${u.name} (${u.email || 'no email'})`;
                            ul.appendChild(li);
                        });
                        container.innerHTML = '';
                        container.appendChild(ul);
                    } catch (err) {
                        container.textContent = 'Failed to load users';
                        console.error(err);
                    }
                });

                // Login form validation (client-side lookup against /users)
                const form = document.getElementById('login-form');
                let msg = document.getElementById('login-message');
                if (!msg) {
                    msg = document.createElement('div');
                    msg.id = 'login-message';
                    msg.style.marginTop = '8px';
                    form.parentNode.insertBefore(msg, form.nextSibling);
                }

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    msg.textContent = 'Checking credentials...';
                    const email = document.getElementById('email-login').value.trim();
                    const password = document.getElementById('password-login').value;
                    try {
                        const res = await fetch('http://localhost:3000/users');
                        if (!res.ok) throw new Error(res.statusText || 'Network error');
                        const users = await res.json();
                        const user = users.find(u => u.email === email);
                        if (!user) {
                            msg.textContent = 'User not found';
                            return;
                        }
                        if (user.password !== password) {
                            msg.textContent = 'Incorrect password';
                            return;
                        }
                        msg.textContent = `Welcome, ${user.name}! Redirecting...`;
                        setTimeout(() => { window.location.href = 'index.html'; }, 800);
                    } catch (err) {
                        msg.textContent = 'Login failed';
                        console.error(err);
                    }
                });
            })();
        </script>
    </body>
</html>
